---
// Data file `navigation.ts`
import { menu } from '../footer';

import { SITE } from '../config';
import { getItem, setItem } from '@util/Cache.astro';
import { setCurrentPage } from '@util/NavPage.astro';
import { NavPage, isNavPage } from '@util/NavigationTypes.astro';
import { getTaxonomy } from '@util/Taxonomy.astro';
import { Lang } from '@util/Languages.astro';
import { addSlashToAddress } from '@util/Url.astro';
import t from '@util/language.json';

export async function getMenu (currentUrl: URL, lang: string) {
    const key = 'Footer__getMenu_' + lang;
    let pages: NavPage[] = await getItem(key);

    if (pages == null) {
        pages = [];
        for (let i = 0; i < menu.length; i++) {
            const item = menu[i];
            if (isNavPage(item)) {
                pages.push(item);
            } else {
                switch (item) {
                    case 'tags':
                        const tags = await getTags(currentUrl, lang);
                        for (let j = 0; j < tags.length; j++) {
                            pages.push(tags[j]);
                        }
                        break;
                    case 'toptags':
                        const toptags = await getTopTags(currentUrl, lang);
                        for (let j = 0; j < toptags.length; j++) {
                            pages.push(toptags[j]);
                        }
                        break;
                    case 'categories':
                        const categories = await getCategories(currentUrl, lang);
                        for (let j = 0; j < categories.length; j++) {
                            pages.push(categories[j]);
                        }
                        break;
                }
            }
        }

        // Cache the result
        await setItem(key, pages);
    }

    setCurrentPage(pages, currentUrl);

    return pages;
}

export async function getCategories (currentUrl: URL, lang: string) {

    const key = 'Footer__getCategories_' + lang;
    let pageHierarchy: NavPage[] = await getItem(key);

    if (pageHierarchy == null) {
        const _ = Lang(lang);
        const category = _(t.articles.category) ?? 'category';
        const categoryTitle = _(t.articles.category_title) ?? 'Categories';
        const categoryLink = `${SITE.subfolder}/${category}/`;

        function getCategoryLink(category: string) {
            return addSlashToAddress(categoryLink + category.toLowerCase().replace(/ /g, '-') + '/1/');
        }

        let order = 0;

        const taxonomy = await getTaxonomy();

        pageHierarchy = [{
            title: categoryTitle,
            url: categoryLink,
            ariaCurrent: false,
            isOpen: false,
            order: 1,
            section: '',
            children: taxonomy.categories.map(item => {
                return {
                    title: item.title,
                    url: getCategoryLink(item.title),
                    ariaCurrent: false,
                    isOpen: false,
                    order: ++order,
                    section: '',
                    children: []
                };
            })
        }];
       
        // Cache the result
        await setItem(key, pageHierarchy);
    }

    return pageHierarchy;
}

export async function getTags (currentUrl: URL, lang: string) {

    const key = 'Footer__getTags_' + lang;
    let pageHierarchy: NavPage[] = await getItem(key);

    if (pageHierarchy == null) {
        const _ = Lang(lang);
        const tag = _(t.articles.tag) ?? 'tag';
        const tagTitle = _(t.articles.tag_title) ?? 'Tags';
        const tagLink = `${SITE.subfolder}/${tag}/`;

        function getTagLink(tag: string) {
            return addSlashToAddress(tagLink + tag.toLowerCase().replace(/ /g, '-') + '/1/');
        }

        let order = 0;

        const taxonomy = await getTaxonomy();

        pageHierarchy = [{
            title: tagTitle,
            url: tagLink,
            ariaCurrent: false,
            isOpen: false,
            order: 1,
            section: '',
            children: taxonomy.tags.map(item => {
                return {
                    title: item.title,
                    url: getTagLink(item.title),
                    ariaCurrent: false,
                    isOpen: false,
                    order: ++order,
                    section: '',
                    children: []
                };
            })
        }];
    
        // Cache the result
        await setItem(key, pageHierarchy);
    }

    return pageHierarchy;
}

export async function getTopTags (currentUrl: URL, lang: string) {

const key = 'Footer__getTopTags_' + lang;
let pageHierarchy: NavPage[] = await getItem(key);

if (pageHierarchy == null) {
    const _ = Lang(lang);
    const tag = _(t.articles.tag) ?? 'tag';
    const tagTitle = _(t.articles.tag_title) ?? 'Tags';
    const tagLink = `${SITE.subfolder}/${tag}/`;

    function getTagLink(tag: string) {
        return addSlashToAddress(tagLink + tag.toLowerCase().replace(/ /g, '-') + '/1/');
    }

    let order = 0;

    const taxonomy = await getTaxonomy();

    pageHierarchy = [{
        title: tagTitle,
        url: tagLink,
        ariaCurrent: false,
        isOpen: false,
        order: 1,
        section: '',
        children: taxonomy.topTags.map(item => {
            return {
                title: item.title,
                url: getTagLink(item.title),
                ariaCurrent: false,
                isOpen: false,
                order: ++order,
                section: '',
                children: []
            };
        })
    }];

    // Cache the result
    await setItem(key, pageHierarchy);
}

return pageHierarchy;
}
---